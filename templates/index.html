<!DOCTYPE html>
<html>
<head>
    <title>Text Input Example</title>
    <link rel="stylesheet" href="/static/style.css">
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

	<script>
        // Função para enviar o chat via AJAX
        async function sendMessage(event) {
            event.preventDefault(); // Impede o envio tradicional do formulário

            const user_input = document.getElementById("user_input").value;  // Pegando a entrada do usuário
            const session_id = document.getElementById("session_id").value;  // Pegando o session_id

            if (!user_input) return;  // Evita enviar uma mensagem vazia

			// Garante que a área do histórico de chat existe
			let chatHistory = document.querySelector(".chat-history");
			if (!chatHistory) {
				chatHistory = document.createElement("div");
				chatHistory.classList.add("chat-history");
				document.querySelector(".chat-container").insertBefore(chatHistory, document.querySelector("form"));
			}
			
            const userMessageDiv = document.createElement("div");
            userMessageDiv.classList.add("message", "user");
            userMessageDiv.innerHTML = user_input;
            chatHistory.appendChild(userMessageDiv);
            
            // Limpa o campo de entrada
            document.getElementById("user_input").value = "";

			const assistantMessageDiv = document.createElement("div");
			assistantMessageDiv.classList.add("message", "assistant");
			chatHistory.appendChild(assistantMessageDiv);

            // Envia a solicitação para o servidor usando Fetch
            const response = await fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({
                    user_input: user_input,
                    session_id: session_id
                })
            });

			if (!response.body) {
				assistantMessageDiv.innerHTML = "<i>Erro no streaming</i>";
				return;
			}

			const reader = response.body.getReader();
			const decoder = new TextDecoder();
	
			let fullText = "";
			let done = false;
			while (!done) {
				const { value, done: doneReading } = await reader.read();
				done = doneReading;
				if (value) {
					const chunk = decoder.decode(value, { stream: true });
					fullText += chunk;
					assistantMessageDiv.innerHTML = marked.parse(fullText);
					// Scroll down as new content appears
					assistantMessageDiv.scrollIntoView({ behavior: "smooth", block: "end" });
				}
			}
        }
    </script>
	
</head>
<body>

    <div class="chat-container">
        <h1>AI Test</h1>
        
        {% if conversation %}
            <div class="chat-history">
                {% for message in conversation %}
                    {% if message.role != 'system' %}
                        <div class="message {{ message.role }}">
                            {{ message.content | safe }}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
		
		<form onsubmit="sendMessage(event)">
            <input type="hidden" name="session_id" id="session_id" value="{{ session_id }}">
            <input type="text" name="user_input" id="user_input" placeholder="Ask anything" required>
			<button type="submit">Send</button>
        </form>
    </div>
</body>

</html>
